# MarzbanSudo โ Handover & Operations Guide (v1)

ุงู ุณูุฏ ุจุฑุง ูุงฺฏุฐุงุฑ ูพุฑูฺู ุจู ุชูุณุนูโุฏููุฏู/ุงูพุฑุงุชูุฑ ุฌุฏุฏ ุชูู ุดุฏู ุงุณุช. ุดุงูู ูุนุฑู ฺฉูุ ูุญูู ุฑุงูโุงูุฏุงุฒุ ุณุงุฎุชุงุฑ ฺฉุฏุ ุชูุถุญ ุฌุฑุงูโูุง (ฺฉุงุฑุจุฑ/ุงุฏูู)ุ ุชูุธูุงุช ู ุนููุงุช ุฑูุฒูุฑู ุงุณุช ุชุง ุงุฏุงูู ุชูุณุนู/ูพุดุชุจุงู ุจุฏูู ุงุจูุงู ุงูุฌุงู ุดูุฏ.

---

## 1) ุฎูุงุตู ู ูุฏู ูุญุตูู
MarzbanSudo ฺฉ ุฑุจุงุช ุชูฺฏุฑุงู (aiogram v3) ุงุณุช ฺฉู ูุฑูุด ู ูุฏุฑุช ุงุดุชุฑุงฺฉ VPN ูุจุชู ุจุฑ Marzban ุฑุง ูุฑุงูู ูโฺฉูุฏ. ูฺฺฏโูุง ฺฉูุฏ:
- ูุณุช ูพููโูุงุ ุฎุฑุฏ ุงุฒ ยซฺฉู ูพููยป ุฏุงุฎูุ Provision ุฎูุฏฺฉุงุฑ ุฏุฑ Marzban ู ุงุฑุณุงู ููฺฉโูุง ุงุดุชุฑุงฺฉ ุจู ฺฉุงุฑุจุฑ
- ุดุงุฑฺ ฺฉู ูพูู ุจุง ุขูพููุฏ ุนฺฉุณ ุฑุณุฏ (ฺฉุงุฑุชโุจูโฺฉุงุฑุช โ ุจุฏูู ฺฉูพุดู)ุ ุชุงุฏ/ุฑุฏ ุชูุณุท ุงุฏูู ุจูโุตูุฑุช Inline
- ููุงุด ูุถุนุช ุงฺฉุงูุช (ุญุฌู/ูุตุฑู/ุจุงูโูุงูุฏู/ุงููุถุง) ู ููฺฉโูุง sub4me
- ฺฉูุชุฑูโูุง ุงุฏูู ุฑู ฺฉุงุฑุจุฑุงู ู ุตูโูุง (Approve/Reject)

---

## 2) ูพุดุชู ููุงูุฑ ู ูุงุจุณุชฺฏโูุง
- Python 3.11ุ aiogram v3ุ httpxุ SQLAlchemy 2 (async) + asyncmyุ Alembic
- ูพุงฺฏุงูโุฏุงุฏู: MariaDB 10.11/ MySQL 8
- Docker + Compose ุจุฑุง ุงุฌุฑุง

ูุงู requirements.txt ูุณุฎู ุฏูู ฺฉุชุงุจุฎุงููโูุง ุฑุง ูุดุฎุต ฺฉุฑุฏู ุงุณุช.

---

## 3) ุณุงุฎุชุงุฑ ูุฎุฒู ู ูุงูโูุง ููู
```
app/
  main.py                 # ููุทู ูุฑูุฏ ุฑุจุงุช (polling)
  logging_config.py       # ูุงฺฏ ุณุงุฎุชุงุฑุงูุชู/ูุงู
  healthcheck.py          # ฺฺฉ ุณูุงูุช (ุชูฺฉู ุชูฺฏุฑุงู + DB)
  config.py               # ุจุงุฑฺฏุฑ ุชูุธูุงุช ุงุฒ env (ุฏุฑ ุญุงู ุงุณุชูุงุฏู ูุญุฏูุฏ)
  bot/
    handlers/
      start.py            # /start ู ููู ููุดโูุญูุฑ (ฺฉุงุฑุจุฑ/ุงุฏูู)
      plans.py            # ูุณุช ูพููโูุง ุจุง ุตูุญูโุจูุฏ + ุฎุฑุฏ ุงุฒ ฺฉู ูพูู
      account.py          # ููุงุด ูุถุนุช ุงฺฉุงูุช ุจุง ูุงูุจโุจูุฏ ุฏู ุฑูู ู ุฏฺฉูู Refresh
      orders.py           # ูุณุช ุณูุงุฑุดโูุง ุงุฎุฑ (Read-only)
      admin.py            # (ุงุฎุชุงุฑ/ุชุงุฑุฎ) ูุฑูุฏโูุง ุงุฏูู
      admin_manage.py     # ุฏุณุชูุฑุงุช ุง๏ฟฝ๏ฟฝูู ุจุฑุง ฺฉุงุฑุจุฑ/Marzban (create/delete/reset/...)
      admin_orders.py     # ุตู ุณูุงุฑุดโูุง pending (Approve/Reject)
      wallet.py           # ฺฉู ูพูู: ุดุงุฑฺ ุจุง ุนฺฉุณุ ูุจุงูุบ ูพุดโูุฑุถ/ุฏูุฎูุงูุ ุชุงุฏ/ุฑุฏ ุงุฏูู
    middlewares/
      rate_limit.py       # ูุญุฏูุฏุช ูุฑุฎ ูพุงู ฺฉุงุฑุจุฑ
  db/
    models.py             # ORM: User/Plan/Order/WalletTopUp/Setting/Transaction/AuditLog
    session.py            # ุงุชุตุงู async + session_scope()
    migrations/           # Alembic (env.py, versions/*)
  services/
    marzban_ops.py        # ุนููุงุช ุงูู Marzban (UI-safe)
    provisioning.py       # Provision ุชุฑุงู ู ฺฉูฺฉโุชุงุจุนโูุง
    scheduler.py          # (ุงุณฺฉูุช) ฺฉุงุฑูุง ุฒูุงูโุจูุฏโุดุฏู
    audit.py              # ุซุจุช ูุงฺฏ ููุฒ (AuditLog)
  marzban/
    client.py             # ฺฉูุงูุช httpx ุจุง ุฏุฑุงูุช ุชูฺฉู ู retry ูุญุฏูุฏ
scripts/
  # ุงุจุฒุงุฑูุง/ุงุณฺฉุฑูพุชโูุง ุฌุงูุจ
Dockerfile, docker-compose.yml, alembic.ini
README.md, Roadmap.md, changelog.md, Info.md (ุงู ูุงู)
```

---

## 4) ูุตุจ ู ุงุฌุฑุง (Production/Staging)
ูพุดโูุงุฒูุง: Docker/Composeุ MariaDB/MySQLุ Marzban 0.8.4 ูุงุจู ุฏุณุชุฑุณ ุจุง HTTPS.

- ุชูุธู .env ุจุฑ ุงุณุงุณ .env.example (ุฏุฑ ูุณุฑ ูพุฑููุงู)
- ุงุฌุฑุง ููุงุฌุฑุชโูุง ุฏุฑ ุงุณุชุงุฑุชุงูพ ุฑุจุงุช ุจุง Compose ูพฺฉุฑุจูุฏ ุดุฏู ุงุณุช:
  - `command: sh -c "alembic upgrade head && python -m app.main"`
- ุงุฌุฑุง ุณุฑูุณ:
```
./update.sh   # ุง:
docker compose up -d --build --no-deps bot
```
- ุงุฌุฑุง ุฏุณุช ููุงุฌุฑุช (ุฏุฑ ุตูุฑุช ูุงุฒ):
```
docker compose exec bot alembic upgrade head
```

ุณูุงูุช:
- healthcheck ุงุฒ DB ู ุชูฺฉู ุชูฺฏุฑุงู ุงุทููุงู ูโุฏูุฏ. ูุงฺฏโูุง ุฑุง ุฏุฑ Compose ุจุฑุฑุณ ฺฉูุฏ.

---

## 5) ุชูุธูุงุช ูุญุท (ENV)
ฺฉูุฏูุง ุญุงุช:
- TELEGRAM_BOT_TOKEN
- TELEGRAM_ADMIN_IDS=111111111,222222222
- DB_URL=mysql+asyncmy://sudo_user:PASS@db:3306/marzban_sudo?charset=utf8mb4
- MARZBAN_BASE_URL=https://<panel>
- MARZBAN_ADMIN_USERNAME, MARZBAN_ADMIN_PASSWORD
- SUB_DOMAIN_PREFERRED=irsub.fun
- RATE_LIMIT_USER_MSG_PER_MIN=20
- (Wallet) MIN_TOPUP_IRR (ฺฉููู ุดุงุฑฺ ุจู ุฑุงูุ ููุงุด ุจู ุชููุงู)

ุงุฏุฏุงุดุช: ุฏุฑ ูพุงูโูุง ููู ูุจุงูุบ ุจู ุชููุงู ููุงุด ุฏุงุฏู ูโุดูุฏ (IRR/10)ุ ุงูุง ุฏุฑ DB ุจู ุฑุงู ุฐุฎุฑู ูโฺฏุฑุฏุฏ.

---

## 6) ุฏุชุงูุฏู โ ฺฉูุฏูุง
- User: telegram_idุ marzban_username (tg_<id>)ุ subscription_tokenุ balance (ุฑุงู)ุ expire_atุ data_limit_bytes ...
- Plan: template_idุ titleุ price (ุฑุงู)ุ duration_daysุ data_limit_bytes ...
- Order: user_idุ plan_idุ status(pending/paid/provisioned/failed)ุ amountุ provider(wallet|...)
- WalletTopUp: user_idุ amount(IRR)ุ status(pending/approved/rejected)ุ receipt_file_idุ admin_idุ timestamps
- Setting: key/value (ูุซูุงู MIN_TOPUP_IRR)
- AuditLog: actor/admin/system/userุ actionุ target_type/idุ meta

Migrations ุชุญุช app/db/migrations ูฺฏูุฏุงุฑ ูโุดููุฏ. ูุณุฎู ุงุฎุฑ: 20250829_000002_wallet.py.

---

## 7) ุฌุฑุงูโูุง ฺฉุงุฑุจุฑ
- Start ู ููู:
  - ุชุดุฎุต ููุด (ุงุฏูู/ฺฉุงุฑุจุฑ) ู ููุงุด ฺฉุจูุฑุฏ ููุงุณุจ.
- ูพููโูุง (๐):
  - ูุณุช ุตูุญูโุจูุฏโุดุฏู ุจุง Buy (Inline). ููุช ุงุฒ plans ฺฏุฑูุชู ูโุดูุฏ.
  - Buy: ุงฺฏุฑ ููุฌูุฏ ฺฉุงู ูุจุงุดุฏ โ ุฑุงูููุง ุดุงุฑฺ ฺฉู ูพูู. ุฏุฑ ุบุฑ ุงูโุตูุฑุช: ฺฉุณุฑ ููุฌูุฏุ ุงุฌุงุฏ Orderุ Provision ุฎูุฏฺฉุงุฑ ู ุงุฑุณุงู ููฺฉโูุง.
- ฺฉู ูพูู (๐ณ):
  - ููุงุด ููุฌูุฏ (ุชููุงู)ุ ูุจุงูุบ ูพุดโูุฑุถ (ุชููุงู) + ุฏฺฉูู ยซูุจูุบ ุฏูุฎูุงูยป
  - ยซูุจูุบ ุฏูุฎูุงูยป: ฺฉุงุฑุจุฑ ุนุฏุฏ ุชููุงู ุงุฑุณุงู ูโฺฉูุฏ (ููุท ุฑููุ ูุซู 76000)
  - ุณูพุณ ุฑุจุงุช ุฏุฑุฎูุงุณุช ุนฺฉุณ/ูุงู ูโุฏูุฏุ ุจุง ุงุฑุณุงูุ WalletTopUp(pending) ุซุจุช ู ุจุฑุง ุงุฏููโูุง ุงุฑุณุงู ูโุดูุฏ.
- ุณูุงุฑุดโูุง (๐ฆ):
  - ููุท ูุณุช ุขุฎุฑู 10 ุณูุงุฑุด ฺฉุงุฑุจุฑ (Read-only).
- ุงฺฉุงูุช (๐ค):
  - ููุงุด ุญุฌูโูุง ุจุง ุฏู ุฑูู ุงุนุดุงุฑ ู ููฺฉโูุง sub4meุ ุฏฺฉูู Refresh ุฏุงุฎู ูพุงู (ฺฉุงูโุจฺฉ ูุงุจู ูพุงุฏูโุณุงุฒ).

---

## 8) ุฌุฑุงูโูุง ุงุฏูู
- ุณูุงุฑุดโูุง ุฏุฑ ุงูุชุธุงุฑ (๐งพ):
  - Approve/Reject (idempotent). ุฑู Approveุ Provision UI-safe ุงุฌุฑุง ูโุดูุฏุ ุฑู Reject ูุถุนุช failed.
- ุดุงุฑฺ ฺฉู ูพูู (TopUp):
  - ุฑุจุงุช ุนฺฉุณ ฺฉุงุฑุจุฑ ุฑุง ุจุง ุฏฺฉููโูุง Approve/Reject ุจุฑุง ุงุฏูู ูโูุฑุณุชุฏ.
  - Approve: ุงูุฒุงุด ููุฌูุฏ ฺฉุงุฑุจุฑ (ุจุฑุญุณุจ ุฑุงู)ุ ูพุงู ููุฌูุฏ ุฌุฏุฏ ุจู ุชููุงู ุจุฑุง ฺฉุงุฑุจุฑ
  - Reject: ูพุงู ุฑุฏ ุจู ฺฉุงุฑุจุฑ + ุฏุฑุฌ Rejected ุฏุฑ caption ุงุฏูู
- ฺฉูุชุฑูโูุง ฺฉู ูพูู:
  - /admin_wallet_set_min <AMOUNT_IRR>
  - /admin_wallet_balance <username> (ููุงุด ุจู ุชููุงู)
  - /admin_wallet_add <username> <amount_IRR>
- ฺฉูุชุฑูโูุง Marzban:
  - /admin_create, /admin_delete, /admin_reset, /admin_revoke, /admin_set ...

ูฺฉุงุช ุง๏ฟฝ๏ฟฝูู:
- ุฌููฺฏุฑ ุงุฒ ุณุฑุฑุฒ ุณุชูู balance ูุจู ุงุฒ ุชุงุฏ ุดุงุฑฺูุง ุฎู ุจุฒุฑฺฏ
- ACL ุงุฏูู ุจุง TELEGRAM_ADMIN_IDS

---

## 9) ุชูุณุนู ู ุงุณุชุงูุฏุงุฑุฏูุง
- Python 3.11ุ typing ุงุฌุจุงุฑุ SQLAlchemy 2 ORMุ ุงูฺฏู session_scope()
- ูพุงูโูุง ู ฺฉุจูุฑุฏูุง ุจุง aiogram v3 (Router-based)
- ูุงฺฏ ุณุงุฎุชุงุฑุงูุชู JSONุ ุฏุฑ production ุณุทุญ INFO
- Migrations: ููุท ูุณุฑ app/db/migrations ูุนุชุจุฑ ุงุณุชุ ูุณุฎูโูุง stray ุฑุง ุญุฐู/ูุงุฏุฏู ุจฺฏุฑุฏ.
- ูุงุญุฏ ูพูู: ุฐุฎุฑู ุฏุงุฎู ุฑุงูุ ููุงุด ุชููุงู

ฺฉุงูุชโูุง ู ูุณุชูุฏุณุงุฒ:
- ูุฑ ุชุบุฑ ููู ุฏุฑ changelog.md ูุณุชูุฏ ุดูุฏ
- Roadmap.md ูุฑุฌุน ูุนูุงุฑ ู Runbook ุงุณุชุ Info.md ุฑุงูููุง ุนููุงุช ุณุฑุน

---

## 10) ุฑุงูููุง ุนุจโุงุจ
- ุฎุทุง ุณุชูู balance โ ุงุฌุฑุง Alembic ุฏุฑ ูุณุฑ ุตุญุญ (app/db/migrations)
- BadRequest ุฏุฑ ูุฑุงุด ูพุงู ุงุฏูู โ ุจุฑุง ุนฺฉุณ/ูุงู ุงุฒ edit_caption ุงุณุชูุงุฏู ฺฉูุฏ
- 409 ุฑู ุณุงุฎุช ฺฉุงุฑุจุฑ Marzban โ ูุณุฑ UI-safe (create โ PUTs) ุงุณุชูุงุฏู ุดุฏูุ ูุงฺฏโูุง ุฑุง ุจุฑุฑุณ ฺฉูุฏ
- ููุฌูุฏ ฺฉุงู ูุณุช ุฏุฑ ุฎุฑุฏ โ ุงุฒ ๐ณ ฺฉู ูพูู ุดุงุฑฺ ฺฉูุฏุ ุณูพุณ Buy ูุฌุฏุฏ

---

## 11) ฺฺฉโูุณุช ูุงฺฏุฐุงุฑ
- [ ] .env ฺฉุงูู ุฑู ุณุฑูุฑ ู ูุฎู ูฺฏูโุฏุงุดุชู ุดูุฏุ TELEGRAM_ADMIN_IDS ุชูุธู ุดุฏู ุจุงุดุฏ
- [ ] DB ู Alembic up-to-date (alembic upgrade head)
- [ ] SUB_DOMAIN_PREFERRED ููุฏุงุฑุฏู ุดุฏู ุจุงุดุฏ
- [ ] ุฏุณุชุฑุณ ุงุฏูู ุจู ฺฏุฑูู/ฺุช ุงุฏูู ุจุฑุง ุฏุฑุงูุช ุดุงุฑฺูุง
- [ ] ุณูุงุฑููุง ุฒุฑ ุชุณุช ุดุฏู ุจุงุดุฏ:
  - ุดุงุฑฺ ฺฉู ูพูู (ูุจูุบ ูพุดโูุฑุถ + ุฏูุฎูุงู) โ Approve/Reject
  - ุฎุฑุฏ ุงุฒ ููุฌูุฏ ู Provision โ ุฏุฑุงูุช ููฺฉโูุง
  - /account ููุงุด ู Refresh (ุฏุฑ ุตูุฑุช ูพุงุฏูโุณุงุฒ ฺฉุงูโุจฺฉ)
  - /admin_* ุฏุณุชูุฑุงุช ูุฏุฑุช ฺฉุงุฑุจุฑ

---

## 12) ุจุฑูุงููโูุง ุจุนุฏ (High-level)
- ุตูุฑุชุญุณุงุจ ุฏุงุฎู ุจุฑุง ุดุงุฑฺ (Invoice) + ุดูุงุณู ูพฺฏุฑ
- ุตูุญูโุจูุฏ ุตูโูุง ุงุฏูู ู ฺฏุฒุงุฑุดโูุง ฺฉู ูพูู
- ุงูุฒุงุด precision ุณุชูู balance (ุฏุฑ ุตูุฑุช ูุงุฒ) ุจู Numeric(18,2)
- i18n ูพุงูโูุง (fa/en) ู ูุงุญุฏ ูพูู ูุงุจู ุชูุธู
- Providerูุง ูพุฑุฏุงุฎุช ุขููุงู (NowPayments/aqayepardakht) ุจูโุตูุฑุช ุงูุฒูููโุง

---

## 13) ุงุฑุฌุงุนุงุช
- Roadmap.md: ูุดุฎุตุงุช ฺฉุงูู ูุนูุงุฑ/Runbook/Backlog
- changelog.md: ุฌุฒุฆุงุช ุชุบุฑุงุช ุณุฑ ุฒูุงู
- app/marzban/client.py: ูฺฏุงุดุช APIูุง Marzban
